<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Closest Airport Finder</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #map {
      height: 70vh;
    }
    #controls {
      padding: 1em;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
    }
    #info {
      padding: 1em;
    }
    .input-group {
      margin-bottom: 10px;
    }
    label {
      display: inline-block;
      width: 80px;
    }
    input {
      padding: 8px;
      width: 120px;
      margin-right: 10px;
    }
    button {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0069d9;
    }
    .coordinates {
      margin-top: 10px;
      font-style: italic;
      color: #666;
    }
    .loading {
      color: #007bff;
      font-style: italic;
    }
    .error {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="controls">
      <div class="input-group">
        <label for="latitude">Latitude:</label>
        <input type="text" id="latitude" placeholder="e.g., 40.7128">
        <label for="longitude">Longitude:</label>
        <input type="text" id="longitude" placeholder="e.g., -74.0060">
        <button id="find-btn">Find Closest Airport</button>
      </div>
      <div class="coordinates">Or click anywhere on the map</div>
    </div>
    <div id="map"></div>
    <div id="info">Click on the map or allow location access to find the closest airport.</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Initialize map
    const map = L.map("map").setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    let marker;
    let userMarker;
    let polyline; // Store reference to the current polyline

    // Function to fetch closest airport from Flask API
    async function fetchAirport(lat, lon) {
      try {
        // Show loading message
        document.getElementById("info").innerHTML = '<span class="loading">Finding closest airport...</span>';
        
        // Update input fields with current coordinates
        document.getElementById("latitude").value = lat.toFixed(6);
        document.getElementById("longitude").value = lon.toFixed(6);
        
        // Make POST request to Flask endpoint
        const response = await fetch("/closest_airport", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            latitude: lat,
            longitude: lon
          })
        });
        
        // Handle initialization errors
        if (response.status === 503) {
          const errorData = await response.json();
          document.getElementById("info").innerHTML = 
            `<span class="error">${errorData.error || 'Application is still initializing. Please try again in a few moments.'}</span>`;
          return;
        }
        
        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Remove existing markers and polyline if any
        if (marker) {
          map.removeLayer(marker);
        }
        if (userMarker) {
          map.removeLayer(userMarker);
        }
        if (polyline) {
          map.removeLayer(polyline);
        }
        
        // Add marker for user's location
        userMarker = L.marker([lat, lon])
          .addTo(map)
          .bindPopup("Your Location")
          .openPopup();
        
        // Add marker for the closest airport
        marker = L.marker([data.Latitude, data.Longitude])
          .addTo(map)
          .bindPopup(`
            <strong>${data.AirportCode}</strong><br>
            ${data.CityCode}, ${data.CountryName}<br>
            Distance: ${data.DistanceKm} km
          `);
        
        // Draw a line between user location and airport
        polyline = L.polyline([
          [lat, lon],
          [data.Latitude, data.Longitude]
        ], { color: 'blue', dashArray: '5, 10' }).addTo(map);
        
        // Fit map to show both points
        const group = new L.featureGroup([userMarker, marker]);
        map.fitBounds(group.getBounds().pad(0.1));
        
        // Update info display
        document.getElementById("info").innerHTML = `
          Closest airport: <strong>${data.AirportCode}</strong> (${data.CityCode}, ${data.CountryName})<br>
          Distance: <strong>${data.DistanceKm} km</strong>
        `;
        
      } catch (err) {
        console.error("Error:", err);
        document.getElementById("info").innerHTML = 
          `<span class="error">Error fetching airport data: ${err.message}</span>`;
      }
    }

    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          fetchAirport(lat, lng);
        },
        err => {
          console.log("Geolocation permission denied or unavailable:", err);
          document.getElementById("info").innerText = 
            "Geolocation not available. Please click on the map or enter coordinates manually.";
        },
        { timeout: 10000 }
      );
    } else {
      document.getElementById("info").innerText = 
        "Geolocation is not supported by your browser. Please click on the map or enter coordinates manually.";
    }

    // Map click event
    map.on("click", e => {
      fetchAirport(e.latlng.lat, e.latlng.lng);
    });

    // Manual coordinate input
    document.getElementById("find-btn").addEventListener("click", () => {
      const latInput = document.getElementById("latitude").value;
      const lngInput = document.getElementById("longitude").value;
      
      const lat = parseFloat(latInput);
      const lng = parseFloat(lngInput);
      
      if (isNaN(lat) || isNaN(lng)) {
        document.getElementById("info").innerHTML = 
          '<span class="error">Please enter valid latitude and longitude values</span>';
        return;
      }
      
      if (lat < -90 || lat > 90) {
        document.getElementById("info").innerHTML = 
          '<span class="error">Latitude must be between -90 and 90</span>';
        return;
      }
      
      if (lng < -180 || lng > 180) {
        document.getElementById("info").innerHTML = 
          '<span class="error">Longitude must be between -180 and 180</span>';
        return;
      }
      
      fetchAirport(lat, lng);
    });

    // Allow Enter key to trigger search
    document.getElementById("latitude").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        document.getElementById("find-btn").click();
      }
    });
    
    document.getElementById("longitude").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        document.getElementById("find-btn").click();
      }
    });
  </script>
</body>
</html>